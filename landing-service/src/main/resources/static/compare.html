<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Customer Landing Demo</title>
    <style>
        :root { --bg:#0b0f19; --card:#121a2a; --muted:#8aa0c3; --text:#e7eefc; --accent:#4c9ffe; --ok:#1fd18b; --warn:#ff5c77; }
        body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
        .wrap { max-width: 1080px; margin: 32px auto; padding: 0 16px; }
        h1 { font-size: 22px; margin: 0 0 6px; }
        .sub { color: var(--muted); margin: 0 0 16px; line-height:1.4; }
        .row { display:flex; gap:12px; flex-wrap:wrap; }
        .card { background: var(--card); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 14px; flex:1; min-width: 320px; }
        .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        input { background:#0d1424; border:1px solid rgba(255,255,255,0.12); color:var(--text); padding:10px 12px; border-radius:10px; width:160px; }
        button { background: var(--accent); color:#08101f; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; }
        button.secondary { background:#0d1424; color:var(--text); border:1px solid rgba(255,255,255,0.14); font-weight:700; }
        button:disabled { opacity:0.6; cursor:not-allowed; }
        .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,0.14); color:var(--muted); }
        .big { font-size: 34px; font-weight: 900; margin: 6px 0 2px; font-variant-numeric: tabular-nums; }
        .label { color: var(--muted); font-size: 13px; }
        .grid { display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 12px; }
        .item { display:flex; align-items:center; justify-content:space-between; gap:10px; }
        .name { color: var(--text); font-size: 13px; width: 200px; }
        .barWrap { flex:1; height: 10px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow:hidden; }
        .bar { height: 100%; width: 0%; background: rgba(76,159,254,0.9); }
        .ms { width: 86px; text-align:right; color: var(--muted); font-variant-numeric: tabular-nums; }
        .meta { margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.6; }
        .ok { color: var(--ok); }
        .warn { color: var(--warn); }
        pre { background:#0d1424; border:1px solid rgba(255,255,255,0.10); padding:12px; border-radius:12px; overflow:auto; color:#cfe3ff; font-size:12px; max-height: 420px; }
        .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
        .btns button { flex: 0 0 auto; }
    </style>
</head>
<body>
<div class="wrap">
    <h1>Customer Landing Demo Panel</h1>
    <div class="sub">
        Tip: Run <span class="pill">cache-miss</span> once (first time), then run it again to show cache benefit.
    </div>

    <div class="row">
        <div class="card">
            <div class="controls">
                <span class="label">Customer ID</span>
                <input id="cid" value="1" />
                <span class="pill" id="status">idle</span>
                <span class="pill">Last endpoint: <span id="lastEp">—</span></span>
            </div>

            <div class="btns">
                <button onclick="run('cache-miss')">/cache-miss</button>
                <button class="secondary" onclick="run('pre-load')">/pre-load</button>
                <button class="secondary" onclick="run('fan-out')">/fan-out</button>
                <button class="secondary" onclick="run('cache-only')">/cache-only</button>
                <button class="secondary" onclick="run('ods-only')">/ods-only</button>
            </div>

            <div class="meta" id="explain">
                Choose an endpoint to run.
            </div>
        </div>

        <div class="card">
            <div><strong>Timing</strong> <span class="pill">browser measured</span></div>
            <div class="big" id="totalMs">—</div>
            <div class="label">Total round-trip time (ms)</div>

            <div class="grid" id="bars"></div>

            <div class="meta" id="hints">—</div>
        </div>
    </div>

    <div class="row" style="margin-top:12px;">
        <div class="card">
            <div><strong>Response</strong> <span class="pill">raw JSON/text</span></div>
            <pre id="raw">—</pre>
            <div class="row" style="margin-top:16px;">
                <div class="card">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong>Load Test Summary (Same Environment)</strong>
                        <span class="pill">Architecture Comparison</span>
                    </div>
                    <div class="meta" style="margin-top:12px;">
                        <strong>Test Configuration</strong><br/>
                        <em>- 10,000 requests</em><br/>
                        <em>- 100 concurrent users</em><br/>
                        <em>- ApacheBench (ab)</em><br/>
                    </div>

                    <table style="width:100%; margin-top:12px; border-collapse:collapse; font-size:14px;">
                        <thead>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.15); color:#8aa0c3;">
                            <th style="text-align:left; padding:8px;">Access Path</th>
                            <th style="text-align:right; padding:8px;">Avg Latency</th>
                            <th style="text-align:right; padding:8px;">Throughput (RPS)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td style="padding:8px;">Cache Only (Hazelcast)</td>
                            <td style="padding:8px; text-align:right;">6.1 ms</td>
                            <td style="padding:8px; text-align:right;">16,402</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;">ODS Only</td>
                            <td style="padding:8px; text-align:right;">11.7 ms</td>
                            <td style="padding:8px; text-align:right;">8,511</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;">Preload (ODS + Cache)</td>
                            <td style="padding:8px; text-align:right;">12.5 ms</td>
                            <td style="padding:8px; text-align:right;">7,991</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;"><strong>Legacy Fan-out</strong></td>
                            <td style="padding:8px; text-align:right;"><strong>235.8 ms</strong></td>
                            <td style="padding:8px; text-align:right;"><strong>424</strong></td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="meta" style="margin-top:12px;">
                        <strong>Key Observation:</strong><br/>
                        Runtime fan-out is <strong>~39× slower (latency)</strong> and <strong>~97% lower throughput</strong> than a read-optimized model (ODS / Cache).
                        <br/><br/>
                        <em>
                            The goal is not to force everything into cache.
                            The goal is to remove fan-out from the runtime path.
                        </em>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const descriptions = {
        "cache-miss": "Full path: cache → ODS → (if missing) fan-out → save ODS → save cache",
        "pre-load":   "Pre-login warm-up: cache → ODS (load into cache if found). Used to prepare data before landing.",
        "fan-out":    "Legacy init: call source services (fan-out) → save ODS → save cache",
        "cache-only": "Read cache only. Fastest when warm; shows cache behavior clearly.",
        "ods-only":   "Read ODS only. Stable and durable; shows DB read time."
    };

    function endpoint(kind, customerId) {
        return `/api/v1/landing/customer/${encodeURIComponent(customerId)}/${kind}`;
    }

    function setText(id, txt) { document.getElementById(id).textContent = txt; }
    function setHtml(id, html) { document.getElementById(id).innerHTML = html; }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function renderBars(items, maxMs) {
        const el = document.getElementById("bars");
        el.innerHTML = "";
        if (!items || items.length === 0) {
            el.innerHTML = `<div class="label">No breakdown provided by API.</div>`;
            return;
        }

        for (const it of items) {
            const name = it.step || it.service || it.name || it.component || "step";
            const ms = Number(it.ms ?? it.durationMs ?? it.duration ?? 0);
            const pct = maxMs > 0 ? Math.min(100, Math.round((ms / maxMs) * 100)) : 0;

            const row = document.createElement("div");
            row.className = "item";
            row.innerHTML = `
        <div class="name">${escapeHtml(name)}</div>
        <div class="barWrap"><div class="bar" style="width:${pct}%"></div></div>
        <div class="ms">${ms.toFixed(0)} ms</div>
      `;
            el.appendChild(row);
        }
    }

    async function run(kind) {
        const cid = document.getElementById("cid").value.trim();
        const url = endpoint(kind, cid);

        setText("status", "running…");
        setText("lastEp", url);
        setHtml("explain", `<strong>${escapeHtml(kind)}</strong> — ${escapeHtml(descriptions[kind] || "")}`);

        // Disable buttons while running
        document.querySelectorAll("button").forEach(b => b.disabled = true);

        try {
            const t0 = performance.now();
            const res = await fetch(url, { headers: { "Accept": "application/json" }});
            const t1 = performance.now();
            const total = t1 - t0;

            setText("totalMs", total.toFixed(0));

            const ct = res.headers.get("content-type") || "";
            let bodyText = "";
            let json = null;

            if (ct.includes("application/json")) {
                json = await res.json();
                bodyText = JSON.stringify(json, null, 2);
            } else {
                bodyText = await res.text();
            }

            setText("raw", bodyText);

            // Try to render breakdown if your API provides it.
            // Supported shapes:
            // 1) { durationMs, breakdown:[{step,ms}] }
            // 2) { totalMs, calls:[{service,ms}] }
            // 3) { timings:[{name,ms}] }
            const breakdown =
                (json && (json.breakdown || json.calls || json.timings || json.steps)) || [];

            const apiTotal =
                (json && Number(json.durationMs ?? json.totalMs ?? json.total ?? 0)) || 0;

            const maxScale = Math.max(apiTotal || 0, total || 0, 1);
            renderBars(breakdown, maxScale);

            // Add hints based on endpoint
            let hint = "";
            if (kind === "cache-only") {
                hint = "If this returns empty/404, run /pre-load or /cache-miss first to warm the cache.";
            } else if (kind === "cache-miss") {
                hint = "Run /cache-miss twice: first time may do fan-out, second time should be cache hit (faster).";
            } else if (kind === "ods-only") {
                hint = "ODS-only is stable and durable; it proves the system still works even if cache is empty.";
            } else if (kind === "fan-out") {
                hint = "Fan-out shows why the legacy path is slower and why removing runtime fan-out matters.";
            } else if (kind === "pre-load") {
                hint = "Pre-load simulates login warm-up to make the landing page fast immediately after login.";
            }

            const ok = res.ok ? `<span class="ok">HTTP ${res.status}</span>` : `<span class="warn">HTTP ${res.status}</span>`;
            setHtml("hints", `Status: ${ok}<br/>Endpoint: <span class="pill">${escapeHtml(kind)}</span><br/>${escapeHtml(hint)}`);

            setText("status", "done");
        } catch (e) {
            setText("status", "error");
            setText("raw", String(e));
            setText("totalMs", "—");
            document.getElementById("bars").innerHTML = `<div class="label">—</div>`;
            setHtml("hints", `<span class="warn">Request failed.</span> Check endpoint path and server logs.`);
        } finally {
            document.querySelectorAll("button").forEach(b => b.disabled = false);
        }
    }
</script>
</body>
</html>